<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dreamlist of 300</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 16px;
        }
        h1 {
            font-size: 24px;
            font-weight: 600;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header-actions { display: flex; gap: 12px; align-items: center; }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary { background: linear-gradient(135deg, #00d4ff, #0099cc); color: #fff; text-decoration: none; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
        .btn-secondary:hover { background: rgba(255,255,255,0.15); }
        .tabs { display: flex; gap: 4px; margin-bottom: 12px; }
        .tab { padding: 8px 16px; border-radius: 8px; cursor: pointer; background: rgba(255,255,255,0.05); }
        .tab.active { background: rgba(0,212,255,0.2); color: #00d4ff; }
        .filter-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
        .filter-row input {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: #fff;
            min-width: 200px;
        }
        .pagination-info { color: rgba(255,255,255,0.7); font-size: 14px; }
        .ref-table {
            display: grid;
            grid-template-columns: 48px 56px 56px 56px 56px;
            gap: 6px;
            padding: 10px 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            margin-bottom: 16px;
            font-size: 13px;
        }
        .ref-table .ref-header { font-weight: 600; color: rgba(255,255,255,0.6); }
        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .section-title h2 { font-size: 16px; font-weight: 600; color: rgba(255,255,255,0.9); }
        .mean-std-wrap { margin-bottom: 12px; background: rgba(255,255,255,0.05); border-radius: 12px; overflow: hidden; }
        .mean-std-wrap .table-row-mean { border-radius: 12px 12px 0 0; }
        .mean-std-wrap .table-row-std { border-radius: 0 0 12px 12px; margin-bottom: 0; }
        .table-wrap { background: rgba(255,255,255,0.05); border-radius: 12px; overflow: hidden; }
        .table-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            background: rgba(0,0,0,0.25);
            font-weight: 600;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 12px;
        }
        .table-header-grid {
            display: grid;
            grid-template-columns: 72px 56px 56px 56px 56px 64px;
            gap: 6px;
            align-items: center;
            flex: 0 0 auto;
        }
        .table-row, .table-row-mean, .table-row-std {
            display: grid;
            grid-template-columns: 72px 56px 56px 56px 56px 64px;
            gap: 6px;
            padding: 8px 12px;
            align-items: center;
            font-size: 13px;
        }
        .table-header-grid > div { text-align: left; user-select: none; }
        .table-header-grid .sortable-label { cursor: pointer; }
        .table-header-grid .sortable-label:hover { color: #00d4ff; }
        .table-header-grid > div[data-sort].active { color: #00d4ff; }
        .table-header .sort-icon { margin-left: 2px; opacity: 0.6; }
        .rank-sym-header { display: flex; align-items: center; gap: 10px; }
        .rank-sym-header .sortable-label.active { color: #00d4ff; }
        .table-row { border-bottom: 1px solid rgba(255,255,255,0.05); }
        .table-row:hover { background: rgba(255,255,255,0.05); }
        .table-row-mean, .table-row-std { font-weight: 600; background: rgba(0,0,0,0.15); }
        .positive { color: #00ff88; }
        .negative { color: #ff4757; }
        .rank-sym { font-weight: 600; color: #00d4ff; display: inline-flex; align-items: baseline; gap: 10px; }
        .rank-sym .rank-num { font-size: 0.7em; opacity: 0.92; }
        .rank-sym .rank-sym-ticker { cursor: pointer; text-decoration: underline; text-underline-offset: 2px; }
        .rank-sym .rank-sym-ticker:hover { opacity: 0.9; }
        .pagination { display: flex; align-items: center; gap: 12px; margin-top: 12px; }
        .pagination button { padding: 6px 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #fff; cursor: pointer; }
        .pagination button:hover:not(:disabled) { background: rgba(255,255,255,0.1); }
        .pagination button:disabled { opacity: 0.4; cursor: not-allowed; }
        .loading { text-align: center; padding: 40px; color: rgba(255,255,255,0.6); }
        .loading-spinner {
            width: 36px; height: 36px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast {
            position: fixed; bottom: 20px; right: 20px;
            padding: 14px 20px; border-radius: 10px;
            background: rgba(0,255,136,0.15); border: 1px solid #00ff88; color: #00ff88;
            transform: translateY(100px); opacity: 0; transition: all 0.3s ease;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.error { background: rgba(255,71,87,0.15); border-color: #ff4757; color: #ff4757; }
        .update-status-banner {
            background: rgba(0,212,255,0.15); border: 1px solid rgba(0,212,255,0.4); color: #00d4ff;
            padding: 10px 16px; border-radius: 8px; margin-bottom: 12px; font-size: 14px;
        }
        #lastUpdated.updated-just-now { animation: pulse 1.5s ease; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }
        .section-title .export-csv-btn { white-space: nowrap; }
        .page-wrap { display: flex; gap: 0; align-items: stretch; min-height: 100vh; }
        .main-content { flex: 1; min-width: 0; }
        .chart-side-panel { width: 0; overflow: hidden; background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%); border-left: 1px solid rgba(0,212,255,0.2); transition: width 0.25s ease; flex-shrink: 0; }
        .chart-side-panel.open { width: 380px; min-width: 320px; overflow: auto; }
        .chart-popup-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .chart-popup-symbol { font-size: 18px; font-weight: 600; color: #00d4ff; }
        .chart-popup-close { width: 36px; height: 36px; border: none; background: rgba(255,255,255,0.1); color: #fff; border-radius: 8px; cursor: pointer; font-size: 18px; line-height: 1; display: flex; align-items: center; justify-content: center; }
        .chart-popup-close:hover { background: rgba(255,255,255,0.2); }
        .chart-popup-body { padding: 12px 16px 16px; }
        .chart-popup-price { margin-bottom: 12px; font-size: 14px; color: rgba(255,255,255,0.9); }
        .chart-popup-price strong { color: #fff; }
        .chart-popup-canvas-wrap { position: relative; height: 220px; margin-bottom: 12px; }
        .chart-popup-legend { display: flex; gap: 16px; margin-bottom: 14px; font-size: 12px; color: rgba(255,255,255,0.7); }
        .chart-popup-legend span { display: inline-flex; align-items: center; gap: 6px; }
        .chart-popup-legend .leg-close { color: #00d9ff; }
        .chart-popup-legend .leg-ma3 { color: #ff9f43; }
        .chart-popup-links { display: flex; flex-direction: column; gap: 8px; }
        .chart-popup-links a { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; background: rgba(0,212,255,0.2); color: #00d4ff; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: 500; }
        .chart-popup-links a:hover { background: rgba(0,212,255,0.3); }
        @media (max-width: 900px) {
            .page-wrap { flex-direction: column; }
        }
        @media (max-width: 768px) {
            .chart-side-panel.open {
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                width: 100%; height: 100%; min-width: 0; max-height: none;
                z-index: 1000; overflow: auto;
                border-left: none; border-radius: 0;
                box-shadow: none;
            }
            .chart-popup-close-mobile { display: inline-flex; align-items: center; gap: 6px; padding: 10px 14px; background: rgba(255,255,255,0.15); color: #fff; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; }
            .chart-popup-close-mobile:hover { background: rgba(255,255,255,0.25); }
            .chart-side-panel.open .chart-popup-canvas-wrap { height: 260px; }
            .chart-side-panel.open .chart-popup-body { padding: 16px; }
        }
        @media (min-width: 769px) {
            .chart-popup-close-mobile { display: none !important; }
        }
        @media (max-width: 768px) {
            .container { padding: 14px; }
            body { font-size: 15px; }
            .pagination-info { font-size: 15px; }
            .ref-table { grid-template-columns: 52px 56px 56px 56px 56px; gap: 6px; font-size: 14px; padding: 10px 12px; }
            .section-title h2 { font-size: 18px; }
            .section-title .export-csv-btn { font-size: 15px; padding: 10px 14px; }
            .table-header { font-size: 13px; padding: 10px 12px; }
            .table-header-grid { grid-template-columns: 68px 54px 54px 54px 54px 58px; gap: 6px; font-size: 13px; }
            .table-row, .table-row-mean, .table-row-std { grid-template-columns: 68px 54px 54px 54px 54px 58px; gap: 6px; font-size: 14px; padding: 8px 12px; }
            .pagination button { font-size: 15px; padding: 8px 14px; }
        }
    </style>
</head>
<body>
    <div class="page-wrap">
        <div class="main-content">
    <div class="container">
        <header>
            <h1>Dreamlist of 300</h1>
            <div class="header-actions">
                <button class="btn btn-secondary" id="btnUpdate" onclick="updateData()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
                    Update
                </button>
                <button class="btn btn-secondary" id="btnCancelUpdate" style="display:none;" onclick="cancelUpdate()">Cancel update</button>
            </div>
        </header>

        <div id="updateStatusBanner" class="update-status-banner" style="display:none;">
            Update in progress… This can take a few minutes. The table will refresh automatically when done.
        </div>

        <div class="filter-row">
            <span class="pagination-info" title="Data last refreshed"><strong>Last updated:</strong> <span id="lastUpdated">-</span></span>
            <span class="pagination-info" id="paginationInfo">Perf: 1-50 of 0</span>
            <div class="pagination">
                <button id="btnPrev" onclick="prevPage()">Prev</button>
                <button id="btnNext" onclick="nextPage()">Next</button>
            </div>
        </div>

        <div class="ref-table" id="refTable">
            <span class="ref-header">REF</span>
            <span class="ref-header">1D</span>
            <span class="ref-header">5D</span>
            <span class="ref-header">20D</span>
            <span class="ref-header">60D</span>
            <span id="refQqqSymbol">QQQ</span>
            <span id="refQqq1d">-</span>
            <span id="refQqq5d">-</span>
            <span id="refQqq20d">-</span>
            <span id="refQqq60d">-</span>
        </div>

        <div class="section-title">
            <h2>Performance</h2>
            <a href="/api/export" download="dreamlist_300.csv" class="btn btn-primary export-csv-btn" onclick="showToast('CSV download started');">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
                Export to CSV
            </a>
        </div>

        <div class="mean-std-wrap">
            <div class="table-row-mean" id="meanRow" style="display:none;">
                <span>MEAN</span>
                <span id="mean1d">-</span>
                <span id="mean5d">-</span>
                <span id="mean20d">-</span>
                <span id="mean60d">-</span>
                <span id="meanRsi">-</span>
            </div>
            <div class="table-row-std" id="stdRow" style="display:none;">
                <span>STD</span>
                <span id="std1d">-</span>
                <span id="std5d">-</span>
                <span id="std20d">-</span>
                <span id="std60d">-</span>
                <span id="stdRsi">-</span>
            </div>
        </div>

        <div class="table-wrap">
            <div class="table-header" id="tableHead" role="row">
                <div class="table-header-grid">
                    <div class="rank-sym-header" role="columnheader">
                        <span data-sort="rank" class="sortable-label">RNK <span class="sort-icon">↕</span></span>
                        <span data-sort="symbol" class="sortable-label">SYM <span class="sort-icon">↕</span></span>
                    </div>
                    <div role="columnheader" data-sort="perf_1d">1D <span class="sort-icon">↕</span></div>
                    <div role="columnheader" data-sort="perf_5d">5D <span class="sort-icon">↕</span></div>
                    <div role="columnheader" data-sort="perf_20d">20D <span class="sort-icon">↕</span></div>
                    <div role="columnheader" data-sort="perf_60d">60D <span class="sort-icon">↕</span></div>
                    <div role="columnheader" data-sort="rsi_14">RSI (14D) <span class="sort-icon">↕</span></div>
                </div>
            </div>
            <div id="tableBody">
                <div class="loading"><div class="loading-spinner"></div>Loading data...</div>
            </div>
        </div>
        <div class="filter-row" style="margin-top:12px;">
            <span class="pagination-info" id="paginationInfo2">Perf: 1-50 of 0</span>
            <div class="pagination">
                <button onclick="prevPage()">Prev</button>
                <button onclick="nextPage()">Next</button>
            </div>
        </div>
    </div>
        </div>
        <div class="chart-side-panel" id="chartSidePanel">
            <div class="chart-popup-header">
                <button type="button" class="chart-popup-close-mobile" id="chartPopupCloseMobile" aria-label="Back">← Back</button>
                <span class="chart-popup-symbol" id="panelSymbol">—</span>
                <button type="button" class="chart-popup-close" id="chartPopupClose" aria-label="Close">&times;</button>
            </div>
            <div class="chart-popup-body">
                <div class="chart-popup-price">Current Price: <strong id="infoCurrentPrice">—</strong></div>
                <div class="chart-popup-canvas-wrap">
                    <canvas id="priceChart"></canvas>
                </div>
                <div class="chart-popup-legend">
                    <span class="leg-close">— Close</span>
                    <span class="leg-ma3">— MA3</span>
                </div>
                <div class="chart-popup-links">
                    <a id="linkCnbc" href="#" target="_blank" rel="noopener">View on CNBC</a>
                    <a id="linkStockcharts" href="#" target="_blank" rel="noopener">View on Stockcharts.com</a>
                </div>
            </div>
        </div>
    </div>
    <div class="toast" id="toast"></div>

    <script>
        let stockData = [];
        let refQqq = {};
        let filteredData = [];
        let sortKey = 'rank';
        let sortDir = 1;
        let page = 1;
        const PAGE_SIZE = 50;

        function fmtPct(val) {
            if (val === null || val === undefined) return '-';
            const sign = val >= 0 ? '+' : '';
            return sign + Number(val).toFixed(1) + '%';
        }
        function pctClass(val) {
            if (val === null || val === undefined) return '';
            return val >= 0 ? 'positive' : 'negative';
        }

        function renderRefTable() {
            document.getElementById('refQqqSymbol').textContent = refQqq.ref || 'QQQ';
            document.getElementById('refQqq1d').textContent = fmtPct(refQqq.perf_1d);
            document.getElementById('refQqq5d').textContent = fmtPct(refQqq.perf_5d);
            document.getElementById('refQqq20d').textContent = fmtPct(refQqq.perf_20d);
            document.getElementById('refQqq60d').textContent = fmtPct(refQqq.perf_60d);
            document.getElementById('refQqq1d').className = pctClass(refQqq.perf_1d);
            document.getElementById('refQqq5d').className = pctClass(refQqq.perf_5d);
            document.getElementById('refQqq20d').className = pctClass(refQqq.perf_20d);
            document.getElementById('refQqq60d').className = pctClass(refQqq.perf_60d);
        }

        function mean(arr, key) {
            const vals = arr.map(r => r[key]).filter(v => typeof v === 'number');
            if (vals.length === 0) return null;
            return vals.reduce((a, b) => a + b, 0) / vals.length;
        }
        function std(arr, key) {
            const vals = arr.map(r => r[key]).filter(v => typeof v === 'number');
            if (vals.length < 2) return null;
            const m = mean(arr, key);
            const variance = vals.reduce((s, v) => s + (v - m) ** 2, 0) / vals.length;
            return Math.sqrt(variance);
        }

        function updateMeanStd(rows) {
            if (!rows.length) return;
            document.getElementById('meanRow').style.display = 'grid';
            document.getElementById('stdRow').style.display = 'grid';
            document.getElementById('mean1d').textContent = fmtPct(mean(rows, 'perf_1d'));
            document.getElementById('mean5d').textContent = fmtPct(mean(rows, 'perf_5d'));
            document.getElementById('mean20d').textContent = fmtPct(mean(rows, 'perf_20d'));
            document.getElementById('mean60d').textContent = fmtPct(mean(rows, 'perf_60d'));
            document.getElementById('meanRsi').textContent = mean(rows, 'rsi_14') != null ? mean(rows, 'rsi_14').toFixed(1) : '-';
            document.getElementById('std1d').textContent = std(rows, 'perf_1d') != null ? std(rows, 'perf_1d').toFixed(1) + '%' : '-';
            document.getElementById('std5d').textContent = std(rows, 'perf_5d') != null ? std(rows, 'perf_5d').toFixed(1) + '%' : '-';
            document.getElementById('std20d').textContent = std(rows, 'perf_20d') != null ? std(rows, 'perf_20d').toFixed(1) + '%' : '-';
            document.getElementById('std60d').textContent = std(rows, 'perf_60d') != null ? std(rows, 'perf_60d').toFixed(1) + '%' : '-';
            document.getElementById('stdRsi').textContent = std(rows, 'rsi_14') != null ? std(rows, 'rsi_14').toFixed(1) : '-';
        }

        function getSortedFiltered() {
            let list = filteredData.slice();
            list.sort((a, b) => {
                let va = a[sortKey], vb = b[sortKey];
                if (typeof va === 'string') return sortDir * (va.localeCompare(vb));
                if (va == null) return sortDir * (vb == null ? 0 : 1);
                if (vb == null) return -sortDir;
                return sortDir * (va - vb);
            });
            return list;
        }

        function renderTable() {
            const list = getSortedFiltered();
            const start = (page - 1) * PAGE_SIZE;
            const chunk = list.slice(start, start + PAGE_SIZE);
            const total = list.length;

            const html = chunk.map(stock => {
                const r1 = stock.perf_1d != null ? pctClass(stock.perf_1d) : '';
                const r5 = stock.perf_5d != null ? pctClass(stock.perf_5d) : '';
                const r20 = stock.perf_20d != null ? pctClass(stock.perf_20d) : '';
                const r60 = stock.perf_60d != null ? pctClass(stock.perf_60d) : '';
                const sym = (stock.symbol || '-').replace(/"/g, '&quot;');
                return `<div class="table-row">
                    <div class="rank-sym"><span class="rank-num">${stock.rank || '-'}</span><span class="rank-sym-ticker" data-symbol="${sym}" role="button" tabindex="0">${stock.symbol || '-'}</span></div>
                    <div class="${r1}">${fmtPct(stock.perf_1d)}</div>
                    <div class="${r5}">${fmtPct(stock.perf_5d)}</div>
                    <div class="${r20}">${fmtPct(stock.perf_20d)}</div>
                    <div class="${r60}">${fmtPct(stock.perf_60d)}</div>
                    <div>${stock.rsi_14 != null ? stock.rsi_14.toFixed(1) : '-'}</div>
                </div>`;
            }).join('');

            document.getElementById('tableBody').innerHTML = html || '<div class="loading">No data</div>';
            document.getElementById('paginationInfo').textContent = total ? `Perf: ${start + 1}-${Math.min(start + PAGE_SIZE, total)} of ${total}` : 'Perf: 0-0 of 0';
            document.getElementById('paginationInfo2').textContent = document.getElementById('paginationInfo').textContent;
            document.getElementById('btnPrev').disabled = page <= 1;
            document.getElementById('btnNext').disabled = start + PAGE_SIZE >= total;
            updateMeanStd(list);
        }

        function applyFilterAndPage() {
            const el = document.getElementById('filterInput');
            const q = (el && el.value ? el.value : '').trim().toLowerCase();
            filteredData = q ? stockData.filter(s => (s.symbol || '').toLowerCase().includes(q)) : stockData.slice();
            page = 1;
            renderTable();
        }

        function prevPage() { if (page > 1) { page--; renderTable(); } }
        function nextPage() {
            const total = getSortedFiltered().length;
            if ((page * PAGE_SIZE) < total) { page++; renderTable(); }
        }

        function updateSortHeaderActive() {
            document.querySelectorAll('.rank-sym-header [data-sort]').forEach(function(el) {
                el.classList.toggle('active', el.dataset.sort === sortKey);
            });
            document.querySelectorAll('.table-header-grid > div[data-sort]').forEach(function(el) {
                el.classList.toggle('active', el.dataset.sort === sortKey);
            });
        }
        document.getElementById('tableHead').addEventListener('click', function(e) {
            const cell = e.target.closest('[data-sort]');
            if (!cell || !cell.dataset.sort) return;
            const key = cell.dataset.sort;
            if (sortKey === key) sortDir = -sortDir; else { sortKey = key; sortDir = 1; }
            updateSortHeaderActive();
            renderTable();
        });

        document.getElementById('tableBody').addEventListener('click', function(e) {
            const ticker = e.target.closest('.rank-sym-ticker');
            if (ticker && ticker.dataset.symbol) showChart(ticker.dataset.symbol);
        });
        document.getElementById('tableBody').addEventListener('keydown', function(e) {
            if (e.key !== 'Enter' && e.key !== ' ') return;
            const ticker = e.target.closest('.rank-sym-ticker');
            if (ticker && ticker.dataset.symbol) { e.preventDefault(); showChart(ticker.dataset.symbol); }
        });

        let priceChart = null;
        function closeChart() {
            document.getElementById('chartSidePanel').classList.remove('open');
            if (priceChart) { priceChart.destroy(); priceChart = null; }
        }
        document.getElementById('chartPopupClose').addEventListener('click', closeChart);
        document.getElementById('chartPopupCloseMobile').addEventListener('click', closeChart);

        async function showChart(symbol) {
            const panel = document.getElementById('chartSidePanel');
            panel.classList.add('open');
            document.getElementById('panelSymbol').textContent = symbol;
            document.getElementById('infoCurrentPrice').textContent = '…';
            document.getElementById('linkCnbc').href = 'https://www.cnbc.com/quotes/' + encodeURIComponent(symbol) + '?qsearchterm=' + encodeURIComponent(symbol);
            document.getElementById('linkStockcharts').href = 'https://stockcharts.com/sc3/ui/?s=' + encodeURIComponent(symbol);
            try {
                const response = await fetch('/api/chart/' + encodeURIComponent(symbol));
                const data = await response.json();
                if (!response.ok) {
                    document.getElementById('infoCurrentPrice').textContent = 'No data';
                    if (priceChart) { priceChart.destroy(); priceChart = null; }
                    return;
                }
                const lastPrice = data.current_price != null ? data.current_price : (data.prices && data.prices.length ? data.prices[data.prices.length - 1] : null);
                document.getElementById('infoCurrentPrice').textContent = lastPrice != null ? '$' + Number(lastPrice).toFixed(2) : '—';
                renderChart(data);
            } catch (err) {
                console.error(err);
                document.getElementById('infoCurrentPrice').textContent = 'Error';
                if (priceChart) { priceChart.destroy(); priceChart = null; }
            }
        }
        function renderChart(data) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            if (priceChart) priceChart.destroy();
            const labels = data.dates || [];
            const prices = data.prices || [];
            const ma3 = data.ma3 || [];
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Close', data: prices, borderColor: '#00d9ff', backgroundColor: 'rgba(0, 217, 255, 0.1)', borderWidth: 2, fill: true, tension: 0.1, pointRadius: 0, pointHoverRadius: 4 },
                        { label: 'MA3', data: ma3, borderColor: '#ff9f43', borderWidth: 2, fill: false, tension: 0.1, pointRadius: 0, borderDash: [5, 5] }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#888', maxTicksLimit: 6 } },
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#888' } }
                    }
                }
            });
        }

        function showToast(msg, isError) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast' + (isError ? ' error' : '');
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        async function loadData() {
            try {
                const res = await fetch('/api/data');
                const data = await res.json();
                stockData = (data.stocks || []).map((s, i) => ({ ...s, rank: s.rank != null ? s.rank : i + 1 }));
                refQqq = data.ref_qqq || {};
                filteredData = stockData.slice();
                page = 1;
                renderRefTable();
                renderTable();
                updateSortHeaderActive();
                const lu = document.getElementById('lastUpdated'); if (lu) lu.textContent = data.last_updated ? new Date(data.last_updated).toLocaleString() : '-';
            } catch (e) {
                console.error(e);
                showToast('Failed to load data', true);
            }
        }

        function showUpdateButton() {
            document.getElementById('btnUpdate').style.display = '';
            document.getElementById('btnUpdate').disabled = false;
            document.getElementById('btnUpdate').innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg> Update';
            document.getElementById('btnCancelUpdate').style.display = 'none';
            document.getElementById('updateStatusBanner').style.display = 'none';
        }

        async function cancelUpdate() {
            try {
                await fetch('/api/update/cancel', { method: 'POST' });
                showToast('Cancelling update...');
                const check = setInterval(async () => {
                    const res = await fetch('/api/status');
                    const d = await res.json();
                    if (!d.is_updating) {
                        clearInterval(check);
                        showUpdateButton();
                        showToast('Update cancelled');
                        loadData();
                    }
                }, 1000);
                setTimeout(() => clearInterval(check), 30000);
            } catch (e) {
                showToast('Cancel failed', true);
            }
        }

        async function updateData() {
            const btn = document.getElementById('btnUpdate');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner" style="width:16px;height:16px;margin:0;"></span> Updating...';
            document.getElementById('btnCancelUpdate').style.display = '';
            document.getElementById('updateStatusBanner').style.display = 'block';
            try {
                const res = await fetch('/api/update', { method: 'POST' });
                const result = await res.json();
                if (result.status === 'success') {
                    showToast('Update started. Table will refresh automatically when done.');
                    const check = setInterval(async () => {
                        const s = await fetch('/api/status');
                        const d = await s.json();
                        if (!d.is_updating) {
                            clearInterval(check);
                            showUpdateButton();
                            await loadData();
                            showToast('Update complete. Table refreshed with latest data.');
                            const lu = document.getElementById('lastUpdated');
                            if (lu) { lu.classList.add('updated-just-now'); setTimeout(() => lu.classList.remove('updated-just-now'), 1500); }
                        }
                    }, 2500);
                    setTimeout(() => clearInterval(check), 600000);
                } else {
                    showToast(result.message || 'Update failed', true);
                    showUpdateButton();
                }
            } catch (e) {
                showToast('Update failed', true);
                showUpdateButton();
            }
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
